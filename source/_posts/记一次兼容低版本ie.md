---
title: 记一次兼容低版本IE
date: 2021/6/15 11:11:46
tags: 
- 框架
- ie
---

## 又名尝试将sm-crypto兼容到ie8

> 前言：
> 
> 完整的配置内容在 [https://github.com/northernCold/sm-crypto](https://github.com/northernCold/sm-crypto)的**ie8分支**
> 
> 项目中密码加密使用的是sm2以及sm3算法，因此选用了[sm-crypto](https://github.com/JuneAndGreen/sm-crypto)开源库，但是因为项目某些加密的需要支持到IE8，且sm-crypto也不支持IE,所以尝试fork该项目，自己动手修改。

## ES6 转 ES5

1. 语法转化

通过设置babel配置文件中的preset,使得能都使用最新的JavsScript

```bash
npm install --save-dev @babel/preset-env
```
```json
{
  "presets": ["@babel/preset-env"]
}
```
2. 原生API的兼容

babel默认只是转化js语法，原生API以及全局对象上的新推出的方法需要使用@babel/polyfill或者@babel/runtime([[@babel_polyfill与@babel_runtime.md]])。不过baebl7以后官方[不推荐](https://babeljs.io/docs/en/babel-polyfill)使用@babel/polyfill，以整体的方式全部在项目中使用。

```bash
npm install --save-dev @babel/preset-env @babel/runtime-corejs3
```
```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage",
        "corejs": 3
      }
    ]
  ],
  "plugins": ["@babel/plugin-transform-runtime"]
}
```

3. [browserslist](https://juejin.cn/post/6844903669524086797)

配置要兼容的浏览器范围

```json
// package.json
"browserslist": [
  "> 1%",
  "last 2 versions",
  "ie >= 8"
]
```

4. ES Module 与 commonjs

还有一个小细节要注意的是，如果项目中使用的是commonjs规范的话，还要修改babel的sourceType的配置（默认是使用ES Moudle规范）。

```json
{
  "targets": "> 1%, last 2 versions, ie >= 8",
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage",
        "corejs": 3
      }
    ]
  ],
  "plugins": ["@babel/plugin-transform-runtime"],
  "sourceType": "script"
}
```
如果项目中既包含commonjs又包含ES Moduel的话，则将sourceType设为`unambiguous`。
## ES5 兼容 ES3

1. 部分方法(Object.defineProperty、Array.isArray、Object.create等)为转换。
  
这里是的处理方法是：在项目代码运行之前，引入兼容的内容。

- [es5-shim](https://github.com/es-shims/es5-shim)
- 如何项目比较小的话，可以运行浏览器调试那些API不兼容，用使用`core-js`一个一个引入不兼容的内容

我使用的是后者方法
```javascript
if (Object.defineProperty) {
  require('core-js/es/object/define-property')
}

if (!Object.create) {
  require('core-js/es/object/create')
}

if (Array.isArray) {
  require('core-js/es/array/is-array')
}
```
> 疑惑：按理来说在将browserslist包括ie8，但是并未将需要在ie8兼容的API和方法并未转换。不知道是什么问题。

2. 关键字转化为字符串

在ie8中，不支持关键字作为对象的属性。所有需要兼容有使用关键字的地方使用字符串的形式。

```bash
npm i es3ify-webpack-plugin --save-dev
```
```javascript
const es3ifyWebpackPlugin = require('es3ify-webpack-plugin');

...
plugins: [
  new es3ifyWebpackPlugin()
],
...
```

3. 压缩支持IE8

在使用压缩插件的使用，还需要主要开始支持IE8，以及避免之前刚刚将关键字添加的引号去掉。

```bash
npm i terser-webpack-plugin --save-dev
```

```javascript
const TerserPlugin = require("terser-webpack-plugin");

...
optimization: {
  minimize: true,
  minimizer: [new TerserPlugin({
    terserOptions: {
      ie8: true,
      compress: {
        properties: false
      },
      output: {
        quote_keys: true
      }
    }
  })],
},
...
```

## REFERENCE

- [babel官网](https://babeljs.io/docs/en/)
- [webpack4编译代码如何完美适配IE内核](http://louiszhai.github.io/2019/12/02/webpack4.ie/#%E4%BB%A3%E7%A0%81%E5%9C%A8IE9%E4%B8%8B%E8%BF%90%E8%A1%8C)
- [ES特性以及Babel支持情况和方案梳理](https://github.com/athm-fe/create-autofe-app/issues/13)


[//begin]: # "Autogenerated link references for markdown compatibility"
[@babel_polyfill与@babel_runtime.md]: @babel_polyfill与@babel_runtime "babel/polyfill与babel/runtime"
[//end]: # "Autogenerated link references"